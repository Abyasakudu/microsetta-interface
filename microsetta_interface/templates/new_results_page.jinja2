{% extends "sitebase.jinja2" %}
{% set page_title = "Sample Results" %}
{% set show_breadcrumbs = True %}

{% block head %}

<link rel="stylesheet" type="text/css" href="/static/vendor/css/jquery.dataTables.css" />
<link id="emperor-css" rel="stylesheet" type="text/css" href="/static/vendor/emperor/css/emperor.css">
<link rel="stylesheet" type="text/css" href="/static/vendor/emperor/vendor/css/jquery-ui.min.css">
<link rel="stylesheet" type="text/css" href="/static/vendor/emperor/vendor/css/slick.grid.min.css">
<link rel="stylesheet" type="text/css" href="/static/vendor/emperor/vendor/css/spectrum.min.css">
<link rel="stylesheet" type="text/css" href="/static/vendor/emperor/vendor/css/chosen.min.css">
<link rel="stylesheet" type="text/css" href="/static/vendor/emperor/vendor/css/jquery.contextMenu.min.css">
<link rel="stylesheet" type="text/css" href="/static/css/4_column_flex.css" />

<style>
    /*Removes the .active, .accordion:hover effect from minimal_interface.css*/
    /* Could potentially use color: initial but has less support...? */
    .tab-pane {
        background-color: #FFFFFF;
        color: #000000;
    }
</style>

<script type="text/javascript" language="javascript" src="/static/js/ruleset.js"></script>
<script src="/static/vendor/js/vega@5"></script>
<script src="/static/vendor/js/vega-lite@4"></script>
<script src="/static/vendor/js/vega-embed@6"></script>
<!-- Datatables must precede emperor imports, they don't play nice with each other. -->
<script type="text/javascript" charset="utf8" src="/static/vendor/js/jquery.dataTables.js"></script>
<script src="/static/vendor/DataTables/Buttons-1.6.2/js/dataTables.buttons.min.js"></script>
<script src="/static/vendor/DataTables/Buttons-1.6.2/js/buttons.html5.min.js"></script>
<!-- plotly must precede emperor imports as well.   I'm getting the feeling
     that emperor doesn't know how to play nice. -->
<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>

<script src="/static/vendor/emperor/vendor/js/require-2.1.22.min.js"></script>
<script src="/static/vendor/emperor/emperor_loader.js"></script>

<script>
    DATA_TYPE_FRIENDLY={
        "16s": "16S",
        "shotgun": "Shotgun"
    }

    DATASET_FRIENDLY={
        "microsetta": "Microsetta"
    }

    function formatAlphaURL(state) {
        let base = state.public_endpoint + '/plotting/diversity/alpha/' + state.alpha_metric + '/percentiles-plot';
        if (state.sample_id !== "") {
            base = base + '?sample_id=' + state.barcode_prefix + state.sample_id;
        }
        return base;
    }

    function populateSelect(select_selector, value_to_text, active_value){
        var select = $(select_selector)
        select.empty()
        for (var v in value_to_text)
        {
            var option = $('<option></option>')
                .attr("value", v)
                .text(value_to_text[v]);

            if (v == active_value)
                option.attr('selected','selected');

            select.append(option)
        }
    }

    function createTaxonomyTable(state)
    {
        $('#taxonomyTable').DataTable(
            {
                ajax: {
                    url: state.public_endpoint + "/taxonomy/present/single/" + state.taxonomy + "/" + state.barcode_prefix + state.sample_id,
                    dataSrc: function(d){
                        var representatives = {}
                        var generaSums = {}
                        //Collapse to genera (Don't show separate rows per species)
                        for (var i = 0; i < d.data.length; i++){
                            //Can't just key by genus because genus can be null/undefined.  Argh.
                            var genus_key = d.data[i].Kingdom + ";" +
                                            d.data[i].Phylum + ";" +
                                            d.data[i].Class + ";" +
                                            d.data[i].Order + ";" +
                                            d.data[i].Family + ";" +
                                            d.data[i].Genus
                            if (genus_key in generaSums)
                            {
                                generaSums[genus_key] += d.data[i].relativeAbundance
                            }
                            else
                            {
                                representatives[genus_key] = d.data[i]
                                generaSums[genus_key] = d.data[i].relativeAbundance
                            }
                        }
                        var newData = []
                        for (genus_key in generaSums){
                            rep = representatives[genus_key]
                            sum = generaSums[genus_key]
                            rep.relativeAbundance = sum
                            newData.push(rep)
                        }
                        return newData;
                    }
                },
                columns: [
                    {
                        data: "relativeAbundance",
                        render: $.fn.dataTable.render.number(',', '.', 4),
                    },
                    {data: "Kingdom"},
                    {data: "Phylum"},
                    {data: "Class"},
                    {data: "Order"},
                    {data: "Family"},
                    {data: "Genus"},
                ],
                order: [[ 0, "desc" ]],
                dom: "Bfrtip",
                buttons: ["csv"]
            }
        );
    }


    function updateCompare(compareData, state){
        if (compareData == null)
            return;  //TODO: Should we mark stale data on this tab somehow?
        //TODO
        //Stuff to fill in:
        //  sample_type, n_bacteria, n_archaea, dataset_name,
        //  n_bacteria_background, n_archaea_background,
        //  age_nearest_neighbor, more_or_less_sweets_nearest_neighbor

        $("#sample_type").text("AJAX_SAMPLE_TYPE")
        $("#n_bacteria").text("AJAX_N_BACTERIA")
        $("#n_archaea").text("AJAX_N_ARCHAEA")
        $("#dataset_name").text(DATASET_FRIENDLY[state.dataset_input.value])
        $("#n_bacteria_background").text("AJAX_BACTERIA_BACKGROUND")
        $("#n_archaea_background").text("AJAX_ARCHAEA_BACKGROUND")
        $("#age_nearest_neighbor").text("AJAX_AGE_NEAREST_NEIGHBOR")
        $("#more_or_less_sweets_nearest_neighbor").text("AJAX_MORE_OR_LESS_SWEETS_NEAREST_NEIGHBOR")
    }
    function updateDiversity(diversityData, state){
        if (diversityData == null) {
            $("#diversity_vis").empty()
            return;
        }
        vegaEmbed("#diversity-vis", diversityData, state.vega_options);
    }
    function updateSimilarity(similarityData, state){
        if (similarityData == null){
            $("#emperor-notebook").empty();
<!--        $(".content").nextAll().remove(); //Why does emperor put stuff out here?  This is hard to find and deal with...-->
            return
        }

        var url = state.public_endpoint + '/plotting/diversity/beta/' + state.beta_metric + '/pcoa/' + state.sample_type + '/emperor?metadata_categories=age_cat&metadata_categories=bmi_cat&metadata_categories=country&metadata_categories=title';
        loadEmperor(
          url,
          "/static/vendor/emperor",
          function(){
          },
          state.barcode_prefix + state.sample_id
        );
    }
    function updateTaxonomy(taxonomyData, state){
        // Seems taxonomy table is static for now, but need to make taxa
        // rank plot
        var sampling_url = state.public_endpoint + '/dataset/' + DATA_TYPE_FRIENDLY[state.data_type_input.value] + '/taxonomy/ranks/taxonomy?' +
            $.param({sample_size: 30000});
        var my_sample_url = state.public_endpoint + '/dataset/' + DATA_TYPE_FRIENDLY[state.data_type_input.value] + '/taxonomy/ranks/taxonomy/sample/' + state.barcode_prefix + state.sample_id

        query1 = $.ajax({
            url: sampling_url,
            type: "GET"
        });

        query2 = $.ajax({
            url: my_sample_url,
            type: "GET"
        });

        $.when(query1, query2).done(function(sampling_results, sample_results){
            var X = 10
            topXOrdered = sampling_results[0]["Taxa-order"].slice(0,X)
            topXOrdered.reverse()
            topX = new Set(topXOrdered)

            var sampling_x = []
            var sampling_y = []
            var sample_x = []
            var sample_y = []
            for (var i =0; i < sampling_results[0].Rank.length; i++)
            {
                if (topX.has(sampling_results[0].Taxon[i]))
                {
                    sampling_x.push(sampling_results[0].Rank[i])
                    sampling_y.push(sampling_results[0].Taxon[i])
                }
            }

            for (var i = 0; i < sample_results[0].Rank.length; i++)
            {
                if (topX.has(sample_results[0].Taxon[i]))
                {
                    sample_x.push(sample_results[0].Rank[i])
                    sample_y.push(sample_results[0].Taxon[i])
                }
            }


            var trace1 = {
                "name": "Rank Distributions",
                "showlegend": false,
                "spanmode": "hard",
                "type": "violin",
                "x": sampling_x,
                "y": sampling_y,
                "orientation": "h",
                "box": {
                    "visible": true
                },
                "meanline": {
                    "visible": true
                },
            }

            var trace2 = {
                "type": "scatter",
                "mode": "markers",
                "name": "My Sample",
                "x": sample_x,
                "y": sample_y
            }
            var data = [trace1, trace2]
            var layout = {
                "title": "Ranked Relative Abundance",
                "yaxis": {
                    "automargin": true,
                    "categoryorder": "array",
                    "categoryarray": topXOrdered
                }
            }
            Plotly.newPlot("taxa-violin", data, layout);
        });
    }

    //Called immediately after a tab is shown
    function onTabShown(evt){
        if (evt.target.id == "similarity-tab")
        {
            // Emperor doesn't seem to understand that the tab has been shown
            // by default.  So we'll trigger a resize event on the window
            // which emperor already links to resize all of its controls.
            // Stupid, but it seems to work, whereas setting width on any of
            // the emperor controls doesn't seem to trigger necessary resizing
            // of the webGL scene
            window.dispatchEvent(new Event('resize'));
        }
    }

    function init(){
        // Hook up fake tab links
        $('.fake-tab').click(function() {
            var link = this.dataset.link
            $(link).click();
        });

        // Listen for tab changes
        $('.nav-link').on('shown.bs.tab', onTabShown);

        // TODO: Should data type options be determined by ajax call or
        // passed into jinja2 template?
        populateSelect(
            "#data_type",
            DATA_TYPE_FRIENDLY,
            "16s"
        );

        // TODO: Should dataset options be determined by ajax call or
        // passed into jinja2 template?
        populateSelect(
            "#dataset",
            DATASET_FRIENDLY,
            "microsetta"
        );

        var state = {}

        // Initialize state
        state.data_type_input = new JQuerySelectInput("DataType", "#data_type");
        state.dataset_input = new JQuerySelectInput("Dataset", "#dataset");
        state.taxonomy = "{{taxonomy}}";
        state.alpha_metric = "{{alpha_metric}}";
        state.beta_metric = "{{beta_metric}}";
        //Just using test barcode because I can never remember a valid one.
        // DONT MERGE WITH FAKE BARCODE HERE.
        state.sample_id = "000023984"; // "{{sample.sample_barcode}}";
        state.barcode_prefix = "{{barcode_prefix}}";
        state.vega_options = {"renderer": "canvas", "actions": true};  /* Options for the Vega embedding */
        state.public_endpoint = "{{public_endpoint}}";
        var sample_type = "oral"
        if ("{{sample.sample_site}}" == "Stool")
            sample_type="fecal"
        state.sample_type = sample_type

        // Doesn't seem any part of taxonomy table needs to be rebuilt yet
        createTaxonomyTable(state)

        /* Whenever data type or dataset are changed, we fire off ajax requests
           to grab new info for the plots.  */
        new DelegateOutput(function(dataType, dataset){
            //TODO: Decide how to tell each control it is waiting on ajax data
            updateCompare(null, state)
            updateDiversity(null, state)
            updateSimilarity(null, state)
            updateTaxonomy(null, state)

            //TODO Insert some calls to ajax, grab the result, -then- update
            //    ...
            $.ajax({
                url: formatAlphaURL(state),
                type: "GET",
                success: function(data){ updateDiversity(data, state); }
            });

            compareData = { "result": "Compare AJAX: " + dataType + " - " + dataset }
            diversityData = { "result": "Diversity AJAX: " + dataType + " - " + dataset }
            similarityData = { "result": "Similarity AJAX: " + dataType + " - " + dataset }
            taxonomyData = { "result": "Taxonomy AJAX: " + dataType + " - " + dataset }

            updateCompare(compareData, state);
            updateDiversity(diversityData, state);
            updateSimilarity(similarityData, state);
            updateTaxonomy(taxonomyData, state);
        }, state.data_type_input, state.dataset_input);
    }

    $(document).ready(init)

</script>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/accounts/{{account_id}}">Account</a></li>
    <li class="breadcrumb-item"><a href="/accounts/{{account_id}}/sources/{{source_id}}">Source</a></li>
    <li class="breadcrumb-item active" aria-current="page">Results</li>
{% endblock %}

{% block content %}
<label for="data_type">Data Type:</label>
<select id="data_type" name="data_type"></select>

<label for="dataset">Dataset:</label>
<select id="dataset" name="dataset"></select>

<div class="row">
    <div class="col-sm-auto">
        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
          <a class="nav-link active" id="compare-tab" data-toggle="pill" href="#compare" role="tab" aria-controls="compare" aria-selected="true">How you compare?</a>
          <a class="nav-link" id="diversity-tab" data-toggle="pill" href="#diversity" role="tab" aria-controls="diversity" aria-selected="false">Your sample diversity</a>
          <a class="nav-link" id="similarity-tab" data-toggle="pill" href="#similarity" role="tab" aria-controls="similarity" aria-selected="false">Diversity similarities</a>
          <a class="nav-link" id="taxonomy-tab" data-toggle="pill" href="#taxonomy" role="tab" aria-controls="taxonomy" aria-selected="false">Taxonomy</a>
        </div>
    </div>
    <div class="col-sm border">
        <div class="tab-content" id="v-pills-tabContent">
          <div class="tab-pane fade show active" id="compare" role="tabpanel" aria-labelledby="compare-tab">
            <div class="column" style="text-align: center">
                <h3>How You Compare</h3>
                <br/>
              <p>
              In your <span id="sample_type">SAMPLE_TYPE</span>, we observed
              <span id="n_bacteria">N_BACTERIA</span> bacterial genera
              and <span id="n_archaea">N_ARCHAEA</span> archaeal genera.  Within
              <span id="dataset_name">DATASET_NAME</span>, we on average observe
              <span id="n_bacteria_background">N_BACTERIA_BACKGROUND</span>
              bacterial genera and
              <span id="n_archaea_background">N_ARCHAEA_BACKGROUND</span>
              archaeal genera.  The most common types of organisms (in a very
              broad sense) that we observe in human associated microbiome samples
              are bacteria and archaea.  But what are bacteria and archaea?
              Well, these are two domains of life that diverged from each other
              billions of years ago.  Humans, on the other hand, are part of the
              eukaryotic domain of life.
              </p>
              <p>
              How diverse is your microbiome?  How many types of organisms are
              there?  Did your sample capture everything there is to see- even
              the rarest of microbes?  You can check several measures of this
              on the <a class="fake-tab" href="#diversity" data-link="#diversity-tab">Your sample diversity</a> tab.
              </p>
              <p>
              How does your sample compare to others?  We can compare your sample
              to others by way of your microbiome.  For example, the person most
              microbially similar to you is <span id="age_nearest_neighbor">AGE_IN_YEARS_OF_NEAREST_NEIGHBOR</span>
              and eats <span id="more_or_less_sweets_nearest_neighbor">MORE_OR_LESS</span>
              sugary sweets than you!  If you'd like to visualize how you compare
              to other, please select <a class="fake-tab" href="#similarity" data-link="#similarity-tab">Diversity similarities</a> from the navigation
              bar.
              </p>
              <p>
              What are these organisms in your sample?  To check what types of
              organisms we observed in your sample, please select
              <a class="fake-tab" href="#taxonomy" data-link="#taxonomy-tab">Taxonomy</a>
              from the navigation bar.
              </p>
            </div>
          </div>
          <div class="tab-pane fade" id="diversity" role="tabpanel" aria-labelledby="diversity-tab">
            <div class="column" style="text-align: center">
                <h3>Alpha Diversity</h3>
                <br>
                <p>Here, we're providing a measure of the diversity of your sample, and how
                it compares to the diversities of all of the same type of samples in The
                Microsetta Initiative. There are many ways to calculate diversity. For
                instance, you could compute a diversity value by counting the number of
                unique organisms observed (i.e., the sample "richness"). Or, you might be
                interested in weighting the calculation by the relative abundance of the
                organisms (i.e., the sample "evenness"). The metric we're computing here is
                called Faith's Phylogenetic Diversity (originally defined
                <a href="https://www.sciencedirect.com/science/article/pii/0006320792912013" target="_blank">here</a>). Faith's Phylogenetic Diversity computes the "richness" of your sample as the amount of evolutionary
                breadth represented by your sample. The way we compute alpha diversity is
                also through <a href="https://qiime2.org" target="_blank">QIIME 2</a>, and
                more information on it can be found in the alpha and beta diversity
                <a href="https://docs.qiime2.org/2020.6/tutorials/moving-pictures/#alpha-and-beta-diversity-analysis" target="_blank">sections</a> of the QIIME 2 tutorial.</p>
                <div id="diversity-vis"></div>
            </div>
          </div>
          <div class="tab-pane fade" id="similarity" role="tabpanel" aria-labelledby="similarity-tab">
            <div class="column" style="text-align: center">
            <h3>Beta Diversity</h3>
            <br>
            <p>Here we display how your sample fits in among the other samples
            of The Microsetta Initiative in terms of shared microbes. There are many
            ways to calculate beta diversity, differing in how to weight the distance
            between any two microbes. We take evolutionary distance into account with
            the metric displayed here, known as Unweighted Unifrac. You can
            find an overview of this metric
            <a href="https://en.wikipedia.org/wiki/UniFrac" target="_blank">here</a> or
            better understand its derivation
            <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1828774/" target="_blank">here</a>.
            This computation is performed with <a href="https://qiime2.org" target="_blank">QIIME 2</a>, and
            more information on it can be found in the alpha and beta diversity
            <a href="https://docs.qiime2.org/2020.6/tutorials/moving-pictures/#alpha-and-beta-diversity-analysis" target="_blank">sections</a> of the QIIME 2 tutorial.</p>
            <div id='emperor-notebook' style="position: relative; width:100%; height:500px;"></div>
            </div>
          </div>
          <div class="tab-pane fade" id="taxonomy" role="tabpanel" aria-labelledby="taxonomy-tab">
              <div class="row">
                  <div class="column" style="text-align: center">
                    <h3> What is in your sample? </h3>
                    <br>
                    <p>The table below shows the relative abundances of all of the organisms we
                    observed in your sample. To produce this, we took the DNA sequences from
                    your sample, and compared them against publicly available annotated
                    reference databases. In some cases, a sequence may uniquely match a
                    database record, in other cases a sequence may match may different records.
                    To handle the uncertainty that can arise, we rely on a well used and
                    publicly available microbiome software package called <a
                    href="https://qiime2.org" target="_blank">QIIME 2</a>. The exact approach
                    taken is highlighted in the main tutorial on
                    <a href="https://docs.qiime2.org/2020.6/tutorials/moving-pictures/#taxonomic-analysis" target="_blank">feature-classification</a>.</p>
                    <div style="padding:10px">
                      <table id="taxonomyTable" class="display" style="width:100%">
                        <thead>
                        <tr>
                          <th>Relative Abundance</th>
                          <th>Kingdom</th>
                          <th>Phylum</th>
                          <th>Class</th>
                          <th>Order</th>
                          <th>Family</th>
                          <th>Genus</th>
                        </tr>
                        </thead>
                      </table>
                    </div>
                  </div>
              </div>
              <hr/>
              <div class="row">
                  <div class="column" style="text-align: center">
                    <p>
                    In the plot below, you can see the most commonly observed
                    microbial genera in the dataset, and distribution of ranks of
                    those genera.  For example, TOP_RANKED_GENUS_FROM_PLOT
                    typically has the highest relative abundance of samples in the
                    dataset.
                    </p>
                  </div>
              </div>
              <div class="row">
                <div id="taxa-violin">
              </div>
          </div>
        </div>
    </div>
</div>
{% endblock %}