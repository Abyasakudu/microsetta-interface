{% extends "sitebase.jinja2" %}
{% set page_title = "Sample Results" %}
{% set show_breadcrumbs = True %}

{% block head %}

<style>
    /*Removes the .active, .accordion:hover effect from minimal_interface.css*/
    /* Could potentially use color: initial but has less support...? */
    .tab-pane {
        background-color: #FFFFFF;
        color: #000000;
    }
</style>

<script type="text/javascript" language="javascript" src="/static/js/ruleset.js"></script>
<script>
    DATA_TYPE_FRIENDLY={
        "16s": "16S",
        "shotgun": "Shotgun"
    }

    DATASET_FRIENDLY={
        "microsetta": "Microsetta"
    }

    populate_select = function(select_selector, value_to_text, active_value){
        var select = $(select_selector)
        select.empty()
        for (var v in value_to_text)
        {
            var option = $('<option></option>')
                .attr("value", v)
                .text(value_to_text[v]);

            if (v == active_value)
                option.attr('selected','selected');

            select.append(option)
        }
    }

    updateCompare = function(compareData, state){
        //TODO
        //Stuff to fill in:
        //  sample_type, n_bacteria, n_archaea, dataset_name,
        //  n_bacteria_background, n_archaea_background,
        //  age_nearest_neighbor, more_or_less_sweets_nearest_neighbor

        $("#sample_type").text("AJAX_SAMPLE_TYPE")
        $("#n_bacteria").text("AJAX_N_BACTERIA")
        $("#n_archaea").text("AJAX_N_ARCHAEA")
        $("#dataset_name").text(DATASET_FRIENDLY[state.dataset_input.value])
        $("#n_bacteria_background").text("AJAX_BACTERIA_BACKGROUND")
        $("#n_archaea_background").text("AJAX_ARCHAEA_BACKGROUND")
        $("#age_nearest_neighbor").text("AJAX_AGE_NEAREST_NEIGHBOR")
        $("#more_or_less_sweets_nearest_neighbor").text("AJAX_MORE_OR_LESS_SWEETS_NEAREST_NEIGHBOR")
    }
    updateDiversity = function(diversityData, state){
        //TODO
        $("#diversity").text(diversityData["result"])
    }
    updateSimilarity = function(similarityData, state){
        //TODO
        $("#similarity").text(similarityData["result"])
    }
    updateTaxonomy = function(taxonomyData, state){
        //TODO
        $("#taxonomy").text(taxonomyData["result"])
    }

    init = function(){
        // Hook up fake tab links
        $('.fake-tab').click(function() {
            var link = this.dataset.link
            $(link).click();
        });

        // TODO: Should data type options be determined by ajax call or
        // passed into jinja2 template?
        populate_select(
            "#data_type",
            DATA_TYPE_FRIENDLY,
            "16s"
        );

        // TODO: Should dataset options be determined by ajax call or
        // passed into jinja2 template?
        populate_select(
            "#dataset",
            DATASET_FRIENDLY,
            "microsetta"
        );

        state = {}

        state.data_type_input = new JQuerySelectInput("DataType", "#data_type");
        state.dataset_input = new JQuerySelectInput("Dataset", "#dataset");

        /* Whenever data type or dataset are changed, we fire off ajax requests
           to grab new info for the plots.  */
        new DelegateOutput(function(dataType, dataset){
            //TODO: Decide how to tell each control it is waiting on ajax data
            updateCompare({"result": "Loading..."}, state)
            updateDiversity({"result": "Loading..."}, state)
            updateSimilarity({"result": "Loading..."}, state)
            updateTaxonomy({"result": "Loading..."}, state)

            //TODO Insert some calls to ajax, grab the result, -then- update
            //    ...

            compareData = { "result": "Compare AJAX: " + dataType + " - " + dataset }
            diversityData = { "result": "Diversity AJAX: " + dataType + " - " + dataset }
            similarityData = { "result": "Similarity AJAX: " + dataType + " - " + dataset }
            taxonomyData = { "result": "Taxonomy AJAX: " + dataType + " - " + dataset }

            updateCompare(compareData, state);
            updateDiversity(diversityData, state);
            updateSimilarity(similarityData, state);
            updateTaxonomy(taxonomyData, state);
        }, state.data_type_input, state.dataset_input);
    }

    $(document).ready(init)

</script>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/accounts/{{account_id}}">Account</a></li>
    <li class="breadcrumb-item"><a href="/accounts/{{account_id}}/sources/{{source_id}}">Source</a></li>
    <li class="breadcrumb-item active" aria-current="page">Results</li>
{% endblock %}

{% block content %}
<label for="data_type">Data Type:</label>
<select id="data_type" name="data_type"></select>

<label for="dataset">Dataset:</label>
<select id="dataset" name="dataset"></select>

<div class="row">
    <div class="col-sm-auto">
        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
          <a class="nav-link active" id="compare-tab" data-toggle="pill" href="#compare" role="tab" aria-controls="compare" aria-selected="true">How you compare?</a>
          <a class="nav-link" id="diversity-tab" data-toggle="pill" href="#diversity" role="tab" aria-controls="diversity" aria-selected="false">Your sample diversity</a>
          <a class="nav-link" id="similarity-tab" data-toggle="pill" href="#similarity" role="tab" aria-controls="similarity" aria-selected="false">Diversity similarities</a>
          <a class="nav-link" id="taxonomy-tab" data-toggle="pill" href="#taxonomy" role="tab" aria-controls="taxonomy" aria-selected="false">Taxonomy</a>
        </div>
    </div>
    <div class="col-sm border">
        <div class="tab-content" id="v-pills-tabContent">
          <div class="tab-pane fade show active" id="compare" role="tabpanel" aria-labelledby="compare-tab">
              <p>
              In your <span id="sample_type">SAMPLE_TYPE</span>, we observed
              <span id="n_bacteria">N_BACTERIA</span> bacterial genera
              and <span id="n_archaea">N_ARCHAEA</span> archaeal genera.  Within
              <span id="dataset_name">DATASET_NAME</span>, we on average observe
              <span id="n_bacteria_background">N_BACTERIA_BACKGROUND</span>
              bacterial genera and
              <span id="n_archaea_background">N_ARCHAEA_BACKGROUND</span>
              archaeal genera.  The most common types of organisms (in a very
              broad sense) that we observe in human associated microbiome samples
              are bacteria and archaea.  But what are bacteria and archaea?
              Well, these are two domains of life that diverged from each other
              billions of years ago.  Humans, on the other hand, are part of the
              eukaryotic domain of life.
              </p>
              <p>
              How diverse is your microbiome?  How many types of organisms are
              there?  Did your sample capture everything there is to see- even
              the rarest of microbes?  You can check several measures of this
              on the <a class="fake-tab" href="#diversity" data-link="#diversity-tab">Your sample diversity</a> tab.
              </p>
              <p>
              How does your sample compare to others?  We can compare your sample
              to others by way of your microbiome.  For example, the person most
              microbially similar to you is <span id="age_nearest_neighbor">AGE_IN_YEARS_OF_NEAREST_NEIGHBOR</span>
              and eats <span id="more_or_less_sweets_nearest_neighbor">MORE_OR_LESS</span>
              sugary sweets than you!  If you'd like to visualize how you compare
              to other, please select <a class="fake-tab" href="#similarity" data-link="#similarity-tab">Diversity similarities</a> from the navigation
              bar.
              </p>
              <p>
              What are these organisms in your sample?  To check what types of
              organisms we observed in your sample, please select
              <a class="fake-tab" href="#taxonomy" data-link="#taxonomy-tab">Taxonomy</a>
              from the navigation bar.
              </p>
          </div>
          <div class="tab-pane fade" id="diversity" role="tabpanel" aria-labelledby="diversity-tab">
              BBB
          </div>
          <div class="tab-pane fade" id="similarity" role="tabpanel" aria-labelledby="similarity-tab">
              CCC
          </div>
          <div class="tab-pane fade" id="taxonomy" role="tabpanel" aria-labelledby="taxonomy-tab">
              DDD
          </div>
        </div>
    </div>
</div>
{% endblock %}